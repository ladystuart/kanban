<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Kanban</title>
  <style>
    body {
        font-family: sans-serif;
        margin:0;
        padding:20px;
        background: linear-gradient(135deg, #6dd5fa, #2980b9);
        color:#333;
        min-height:100vh;
    }
    .top-bar { display:flex; align-items:center; gap:10px; margin-bottom:20px; }
    select, input[type="text"], input[type="date"] { padding:8px; border-radius:6px; border:none; font-size:14px; }
    button { padding:8px 12px; border:none; border-radius:6px; background:#2980b9; color:white; font-weight:bold; cursor:pointer; transition:0.3s; }
    button:hover { background:#1e5f8c; }
    .logout { position:fixed; top:15px; right:20px; background:#fff; color:#2980b9; padding:8px 12px; border-radius:6px; text-decoration:none; font-weight:bold; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    .logout:hover { background:#f1f1f1; }
    form { display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap; }
    
    .columns { 
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        width: 100%;
        overflow-x: auto; 
    }
    
    .column { 
        background: rgba(255,255,255,0.9); 
        border-radius:12px; 
        padding:15px; 
        box-shadow:0 6px 12px rgba(0,0,0,0.15); 
        min-width: 220px; 
    }
    
    h2 { text-align:center; color:#2980b9; margin-bottom:10px; }
    ul { list-style:none; padding:0; }
    li {
        background:#f9f9f9;
        margin:6px 0;
        padding:8px 12px;
        border-radius:6px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        box-shadow:0 2px 4px rgba(0,0,0,0.1);
        transition: 0.2s;
        cursor: pointer;
    }
    li:hover { background: #e0f0ff; }
    #task-sidebar input, #task-sidebar select {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 6px 8px;
        font-size: 14px;
    }
    #task-sidebar input:focus, #task-sidebar select:focus {
        outline: none;
        border-color: #2980b9;
        background-color: #e6f0ff;
    }
    #sidebar-title { max-width: 300px; margin: 0 auto 10px auto; text-align: center; }


    .flash-messages {
    margin: 10px auto;
    max-width: 600px;
    padding: 10px;
    }

    .flash {
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .flash.error {
      background: #ffdddd;
      color: #c0392b;
    }

    .flash.success {
      background: #ddffdd;
      color: #27ae60;
    }

    .flash.info {
      background: #ddeeff;
      color: #2980b9;
    }
  </style>
</head>
<body>

<a class="logout" href="/logout">üö™ Logout</a>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}


<div class="top-bar">
  <form id="select-user-form" action="/" method="get">
    <label for="user">User:</label>
    <select name="user" id="user" onchange="document.getElementById('select-user-form').submit()">
      {% for user in users %}
        <option value="{{ user }}" {% if user == selected_user %}selected{% endif %}>{{ user }}</option>
      {% endfor %}
    </select>
  </form>

  <form action="/add_user" method="post">
    <input type="text" name="username" placeholder="New user" required>
    <button type="submit">Add</button>
  </form>

  {% if selected_user %}
    <form action="/delete_user/{{ selected_user }}" method="get" onsubmit="return confirm('Delete user {{ selected_user }}?')">
      <button type="submit">Delete</button>
    </form>
  {% endif %}
</div>

<!-- Add task form -->
<form action="/add" method="post" style="display:flex; flex-direction:column; gap:10px; width:100%;">
  <div style="display:grid; grid-template-columns: repeat(8, 1fr); gap:10px; width:100%;">
    <input type="text" name="task_title" placeholder="Task title" required>

    <select name="status">
      <option value="todo" selected>To Do</option>
      <option value="in_progress">In Progress</option>
      <option value="waiting">Waiting</option>
      <option value="done">Done</option>
    </select>

    <select name="type">
      <option value="task" selected>Task</option>
      <option value="ASAP">ASAP</option>
    </select>

    <select name="priority">
      <option value="blocker">Blocker</option>
      <option value="critical" selected>Critical</option>
      <option value="medium">Medium</option>
      <option value="low">Low</option>
      <option value="minor">Minor</option>
    </select>

    <input type="date" name="start_date" value="{{ today }}">
    <input type="date" name="deadline">

    <input type="text" name="tags" placeholder="Tags (comma separated)">

    <select name="task_type">
      <option value="AD-HOC">AD-HOC</option>
      <option value="REG">REG</option>
      <option value="PRO">PRO</option>
    </select>
  </div>

  <textarea name="comment" placeholder="Task comment"
    rows="2"
    style="padding:8px; border-radius:6px; box-sizing: border-box; border:1px solid #ccc; font-size:14px; width:100%; resize:vertical;"></textarea>

  <input type="hidden" name="user" value="{{ selected_user }}">
  <button type="submit" style="align-self:flex-start;">Add</button>
</form>

<!-- Kanban board -->
<div class="columns">
  {% for col, title in [("todo","To Do"),("in_progress","In Progress"),("waiting","Waiting"),("done","Done")] %}
    <div class="column">
      <h2>{{ title }}</h2>
      <ul>
        {% for task in tasks.get(col, []) %}
          <li data-task='{{ task|tojson | safe }}' onclick="openSidebarFromLi(this, '{{ col }}')">
              <div style="display:flex; flex-direction:column;">
                  <span>{{ task.title }}</span>
                  <small>Days in this status: {{ task.days_in_status }}</small>
              </div>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endfor %}
</div>

<!-- Task sidebar -->
<div id="task-sidebar" style="position:fixed; top:0; right:0; width:400px; height:100%; background:white;
     box-shadow:-4px 0 12px rgba(0,0,0,0.2); padding:20px; transition:0.3s; overflow-y:auto; z-index:1000; display:none;">
  <button onclick="closeSidebar()" style="float:right; background:#2980b9; color:white; border:none; border-radius:6px; padding:5px 10px; cursor:pointer;">‚ùå</button>
  <h2 id="sidebar-title" contenteditable="true">Task</h2>
  <form id="sidebar-form" method="post" action="/edit_task">
    <input type="hidden" name="user" value="{{ selected_user }}">
    <input type="hidden" name="col" id="sidebar-col">
    <input type="hidden" name="task_id" id="sidebar-id">
    <input type="hidden" name="title" id="sidebar-hidden-title">

    <div style="display:grid; grid-template-columns:120px 1fr; row-gap:10px; column-gap:10px; align-items:center;">
      <label>Status:</label>
      <select name="status" id="sidebar-status">
        <option value="todo">To Do</option>
        <option value="in_progress">In Progress</option>
        <option value="waiting">Waiting</option>
        <option value="done">Done</option>
      </select>

      <label>Type:</label>
      <select name="type" id="sidebar-type">
        <option value="task">Task</option>
        <option value="ASAP">ASAP</option>
      </select>

      <label>Priority:</label>
      <select name="priority" id="sidebar-priority">
        <option value="blocker">Blocker</option>
        <option value="critical">Critical</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
        <option value="minor">Minor</option>
      </select>

      <label>Start date:</label>
      <input type="date" name="start_date" id="sidebar-start-date">

      <label>Deadline:</label>
      <input type="date" name="deadline" id="sidebar-deadline">

      <label>Tags:</label>
      <input type="text" name="tags" id="sidebar-tags">

      <label>Category:</label>
      <select name="task_type" id="sidebar-task-type">
        <option value="AD-HOC">AD-HOC</option>
        <option value="REG">REG</option>
        <option value="PRO">PRO</option>
      </select>

      <label>Comment:</label>
      <textarea name="comment" id="sidebar-comment" rows="3"
        style="padding:8px; border-radius:6px; border:1px solid #ccc; font-size:14px; background-color:#f0f0f0; width:100%;"></textarea>
    </div>

    <button type="submit" style="margin-top:20px; width:100%;">Save</button>
  </form>

  <form id="delete-task-form" method="post" action="/delete_task" style="margin-top:10px;">
    <input type="hidden" name="user" value="{{ selected_user }}">
    <input type="hidden" name="task_id" id="delete-task-id">
    <button type="submit" style="background:#e74c3c; color:white; width:100%; padding:8px 0; border-radius:6px; border:none; cursor:pointer;">Delete Task</button>
  </form>
</div>

<script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>